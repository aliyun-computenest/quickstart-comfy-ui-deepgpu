<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="计算巢是阿里云开放给企业应用服务商的服务管理平台。服务商能够在计算巢上发布私有化部署服务，为其客户提供云上软件一键部署的能力；同时也支持全托管模式的服务，赋能服务商托管其客户资源。">
  <title>ComfyUI DeepGPU加速社区版 部署文档 - Aliyun 计算巢 x Demo</title>

  <link rel="shortcut icon" href="img/favicon.ico">

  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
  <link rel="stylesheet" href="css/theme.css">
  

  

  
  

  
    <script src="search/main.js"></script>
  

  

  <script src="js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body>
  <div class="container">
    <div class="nav">
      <div class="nav-inner">
        <div class="logo">
          <img src="./img/logo-2x.png">
        </div>
        <div class="nav-list">
          <ul>
          
              <li><a href="#comfyui-deepgpu">ComfyUI DeepGPU加速社区版 部署文档</a></li>
              
                  <li><a href="#_1">概述</a></li>
                  
              
                  <li><a href="#_2">部署流程</a></li>
                  
                      <li class="li-h3"><a href="#_3">创建实例</a></li>
                  
              
                  <li><a href="#_4">执行图片生成测试</a></li>
                  
                      <li class="li-h3"><a href="#_5">登录页面</a></li>
                  
                      <li class="li-h3"><a href="#_6">测试</a></li>
                  
                      <li class="li-h3"><a href="#_7">模型切换</a></li>
                  
                      <li class="li-h3"><a href="#_8">性能查看</a></li>
                  
                      <li class="li-h3"><a href="#deepgpu">使用DeepGPU加速</a></li>
                  
                      <li class="li-h3"><a href="#_9">加速性能对比</a></li>
                  
              
                  <li><a href="#fq">F&amp;Q</a></li>
                  
                      <li class="li-h3"><a href="#_10">如何重启服务</a></li>
                  
                      <li class="li-h3"><a href="#log">如何查看log</a></li>
                  
              
          
          </ul>
        </div>
      </div>
    </div>
    <div class="content theme-github">
      
      <div class="content-inner">        
        
        <h1 id="comfyui-deepgpu">ComfyUI DeepGPU加速社区版 部署文档</h1>
<h2 id="_1">概述</h2>
<p><img alt="概述" src="imgs/1.png" /></p>
<p>stable diffusion可以通过使用文字生成图片，在整个pipeline中，包含CLIP或其他模型从文字中提取隐变量；通过使用UNET或其他生成器模型进行图片生成。通过逐步扩散(Diffusion)，逐步处理图像，使得图像的生成质量更高。<strong>通过本文，客户可以搭建一个stable diffusion的ComfyUI框架，并使用DeepGPU加速图片生成速度。在512x512分辨率下，AIACC加速能将推理性能从1.91s降低至0.88s，性能提升至2.17倍，同时AIACC支持任意多LORA权重加载，且不影响性能。</strong></p>
<p>DeepGPU支持优化基于Torch框架搭建的模型，通过对模型的计算图进行切割，执行层间融合，以及高性能OP实现，大幅度提升PyTorch的推理性能。您无需指定精度和输入尺寸，即可通过JIT编译的方式对PyTorch框架下的深度学习模型进行推理优化。具体详见<a href="https://help.aliyun.com/document_detail/317822.html">手动安装AIACC-Inference（AIACC推理加速）Torch版</a>。</p>
<p>ComfyUI版本基于<a href="https://github.com/comfyanonymous/ComfyUI">https://github.com/comfyanonymous/ComfyUI</a>仓库，官方文档为<a href="https://blenderneko.github.io/ComfyUI-docs/">https://blenderneko.github.io/ComfyUI-docs/</a>，如有需要请参阅官方文档。</p>
<h2 id="_2">部署流程</h2>
<h3 id="_3">创建实例</h3>
<p>访问计算巢实例(<a href="https://computenest.console.aliyun.com/user/cn-hangzhou/recommendService">https://computenest.console.aliyun.com/user/cn-hangzhou/recommendService</a>)，点击创建
<strong>ComfyUI DeepGPU加速社区版。</strong></p>
<p>选择所需地域:
<img alt="image.png" src="imgs/2.png" /></p>
<p>勾选实例类型，并填写实例密码：</p>
<p><img alt="image.png" src="imgs/3.png" /></p>
<p>填写登录用户名和密码，用户名和密码在后续登录ComfyUI时使用:</p>
<p><img alt="image.png" src="imgs/4.png" /></p>
<p>点击下一步:确认订单，并勾选服务条款，点击创建：</p>
<p><img alt="image.png" src="imgs/5.png" /></p>
<p>稍等片刻，等待部署完成。</p>
<h2 id="_4">执行图片生成测试</h2>
<h3 id="_5">登录页面</h3>
<p>点击计算巢控制台中的实例:</p>
<p><img alt="image.png" src="imgs/6.png" /></p>
<p>点击其中的endpoint网址：<img alt="image.png" src="imgs/7.png" /></p>
<h3 id="_6">测试</h3>
<p>输入登录信息中的用户名和密码登录:</p>
<p><img alt="image.png" src="imgs/8.png" /></p>
<p>进入测试页面:</p>
<p><img alt="image.png" src="imgs/9.png" /></p>
<p>点击<strong>Queue Prompt</strong>，可以生成一张图片:</p>
<p><img alt="image.png" src="imgs/10.png" /></p>
<h3 id="_7">模型切换</h3>
<p>在测试镜像中，我们预装的模型位于/root/ComfyUI/models/文件夹中，如果需要使用其他模型，可以放置到指定位置，并进行在web页面中进行切换。
例如我们需要切换为预装的stable-diffusion v1.5基准模型，可以将<strong>Load Checkpoint</strong>节点的模型切换为v1-5的模型：</p>
<p><img alt="image.png" src="imgs/11.png" /></p>
<p>点击<strong>Queue Prompt</strong>生成图片：</p>
<p><img alt="image.png" src="imgs/12.png" /></p>
<h3 id="_8">性能查看</h3>
<p>注意此处我们没有使用DeepGPU进行性能加速，性能为comfyUI+xformers的基准性能。
点击计算巢控制台的资源选项卡，点击远程连接登录服务器：
<img alt="image.png" src="imgs/13.png" />
使用如下命令查看日志：</p>
<pre><code class="language-bash">cat /var/log/comfyui.log
</code></pre>
<p><img alt="image.png" src="imgs/14.png" /></p>
<p>可见未优化情况下单次推理耗时为1.33s。</p>
<h3 id="deepgpu">使用DeepGPU加速</h3>
<p>注意：DeepGPU加速功能暂为测试版，如遇到任何问题，请删除相关节点并使用默认的自带节点。并使用运维管理的重启comfyUI服务重启服务：</p>
<p><img alt="image.png" src="imgs/15.png" /></p>
<p>当使用DeepGPU加速时，我们需要使用3个自定义的节点：</p>
<ul>
<li>Load AIACC Checkpoint</li>
<li>Load AIACC LoRA</li>
<li>load AIACC ComtrolNet</li>
</ul>
<p><img alt="image.png" src="imgs/16.png" /></p>
<p>替换原有节点使用。例如在上例中，如果使用DeepGPU加速，则生成流程变更为：</p>
<p><img alt="image.png" src="imgs/17.png" /></p>
<h3 id="_9">加速性能对比</h3>
<p>加速后执行时间从1.33s提升至0.8s，如下图所示。</p>
<p><img alt="image.png" src="imgs/18.png" /></p>
<h2 id="fq">F&amp;Q</h2>
<h3 id="_10">如何重启服务</h3>
<p>一种方法是使用运维服务重启：
<img alt="image.png" src="imgs/19.png" />
另一种方法是进入终端重启：</p>
<ul>
<li>可使用如下命令停止服务:<ul>
<li>systemctl stop comfyui </li>
</ul>
</li>
<li>可使用如下命令打开服务:<ul>
<li>systemctl start comfyui</li>
</ul>
</li>
</ul>
<h3 id="log">如何查看log</h3>
<pre><code>  - cat /var/log/comfyui.log
</code></pre>
        
      </div>

      <div class="copyrights">© 2009-2022 Aliyun.com 版权所有</div>
    </div>
  </div>
  
  <!--
  MkDocs version      : 1.5.3
  Docs Build Date UTC : 2024-02-05 10:57:27.209457+00:00
  -->
</body>
</html>